<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ ‚Äî Finance Manager</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <header class="topbar">
        <div class="logo">–õ–∏—á–Ω—ã–µ —Ñ–∏–Ω–∞–Ω—Å—ã</div>
        <a href="#" id="logoutBtn" class="logout">–í—ã—Ö–æ–¥</a>
    </header>

    <main class="main-content">
        <h1>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏</h1>

        <form id="catForm" class="form-card">
            <input type="text" id="newCat" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é" required>
            <button type="submit">–î–æ–±–∞–≤–∏—Ç—å</button>
        </form>

        <ul id="catList"></ul>

        <button class="next-btn" onclick="window.location.href='index.html'">üè† –ù–∞ –≥–ª–∞–≤–Ω—É—é</button>
    </main>

    <script>
        async function ensureAuth() {
            try {
                const r = await fetch('/api/me');
                const d = await r.json();
                if (!d.logged_in) window.location.href = 'login.html';
            } catch {
                window.location.href = 'login.html';
            }
        }
        ensureAuth();

        async function loadCats() {
            const res = await fetch('/api/categories');
            if (!res.ok) {
                document.getElementById('catList').innerHTML = '<li>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</li>';
                return;
            }
            const d = await res.json();
            const list = document.getElementById('catList');
            list.innerHTML = (d.categories || []).map(c =>
                `<li>${c.name} <button data-id="${c.id}" class="rem">–£–¥–∞–ª–∏—Ç—å</button></li>`
            ).join('');

            document.querySelectorAll('.rem').forEach(b => {
                b.addEventListener('click', async ev => {
                    const id = ev.target.dataset.id;
                    const res = await fetch('/api/categories/' + id, { method: 'DELETE' });
                    if (res.ok) loadCats();
                    else {
                        const dd = await res.json();
                        alert(dd.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å');
                    }
                });
            });
        }
        loadCats();

        document.getElementById('catForm').addEventListener('submit', async e => {
            e.preventDefault();
            const name = document.getElementById('newCat').value.trim();
            if (!name) return;
            const res = await fetch('/api/categories', {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name })
            });
            if (res.ok) {
                document.getElementById('newCat').value = '';
                loadCats();
            } else {
                const d = await res.json();
                alert(d.error || '–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è');
            }
        });

        document.getElementById('logoutBtn').addEventListener('click', async () => {
            await fetch('/api/logout', { method: 'POST' });
            window.location.href = 'login.html';
        });
    </script>
</body>

</html>